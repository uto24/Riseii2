{% extends "base.html" %}

{% block content %}
<div class="min-h-screen flex items-center justify-center -mt-16 px-4">
    
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-8 text-center text-white">
            <h2 id="form-title" class="text-3xl font-bold mb-2">Welcome Back</h2>
            <p class="text-blue-100 text-sm">Please login to your account</p>
        </div>

        <div class="p-8">
            <!-- Google Button -->
            <button onclick="handleGoogleAuth()" type="button" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl transition duration-300 shadow-sm group">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6 group-hover:scale-110 transition" alt="Google">
                <span>Continue with Google</span>
            </button>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Or continue with email</span>
                </div>
            </div>

            <!-- Form -->
            <div id="auth-form" class="space-y-4">
                
                <!-- Signup Fields (Hidden by Default) -->
                <div id="signup-fields" class="hidden space-y-4">
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="name" placeholder="Full Name" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                    </div>
                    
                    <div class="relative">
                        <i class="fab fa-facebook absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="url" id="fb_link" placeholder="Facebook Profile Link (Optional)" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                    </div>

                    <div class="relative">
                        <i class="fas fa-gift absolute left-3 top-3.5 text-gray-400"></i>
                        <input type="text" id="ref_code_input" placeholder="Referral Code (Optional)" class="w-full pl-10 pr-4 py-3 border border-gray-200 bg-gray-50 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>

                <!-- Common Fields -->
                <div class="relative">
                    <i class="fas fa-envelope absolute left-3 top-3.5 text-gray-400"></i>
                    <input type="email" id="email" placeholder="Email Address" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>

                <div class="relative">
                    <i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                    <input type="password" id="password" placeholder="Password" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>

                <!-- Submit Button -->
                <button id="submit-btn" onclick="handleAuth()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3.5 rounded-xl hover:opacity-90 transition transform active:scale-95 shadow-lg">
                    Login Now
                </button>
            </div>

            <!-- Error Message -->
            <p id="status" class="text-center text-red-500 mt-4 text-sm font-medium animate-pulse"></p>

            <!-- Toggle Link -->
            <p class="text-center text-sm text-gray-500 mt-6">
                <span id="toggle-text">Don't have an account?</span> 
                <button onclick="toggleMode()" class="text-blue-600 font-bold hover:underline ml-1">Sign Up</button>
            </p>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
    const firebaseConfig = {{ config|tojson }};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    let isSignup = false; // Default Login Mode

    // Check URL for Referral Code
    const urlParams = new URLSearchParams(window.location.search);
    const refParam = urlParams.get('ref');
    if (refParam) {
        document.getElementById('ref_code_input').value = refParam;
        localStorage.setItem('referral_code', refParam);
        // If ref link used, auto switch to signup
        toggleMode(); 
    }

    function toggleMode() {
        isSignup = !isSignup;
        const signupFields = document.getElementById('signup-fields');
        const title = document.getElementById('form-title');
        const btn = document.getElementById('submit-btn');
        const toggleText = document.getElementById('toggle-text');
        const toggleBtn = toggleText.nextElementSibling;
        const subTitle = title.nextElementSibling;

        if (isSignup) {
            signupFields.classList.remove('hidden');
            title.innerText = "Create Account";
            subTitle.innerText = "Join us and start earning";
            btn.innerText = "Sign Up";
            toggleText.innerText = "Already have an account?";
            toggleBtn.innerText = "Login";
        } else {
            signupFields.classList.add('hidden');
            title.innerText = "Welcome Back";
            subTitle.innerText = "Please login to your account";
            btn.innerText = "Login Now";
            toggleText.innerText = "Don't have an account?";
            toggleBtn.innerText = "Sign Up";
        }
    }

    async function sendToServer(idToken, extraData = {}) {
        const refCode = document.getElementById('ref_code_input').value || localStorage.getItem('referral_code');
        
        const payload = {
            idToken: idToken,
            refCode: isSignup ? refCode : null,
            ...extraData
        };

        const res = await fetch('/session_login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        if(res.status === 403) {
            document.getElementById('status').innerText = data.message; // Show Ban Message
        } else if(data.status === 'success') {
            window.location.href = '/dashboard';
        } else {
            document.getElementById('status').innerText = "Server Error: " + data.message;
        }
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const name = document.getElementById('name').value;
        const fbLink = document.getElementById('fb_link').value;
        const status = document.getElementById('status');

        if(!email || !pass) { status.innerText = "Please fill in all fields"; return; }
        if(isSignup && !name) { status.innerText = "Please enter your name"; return; }

        status.innerText = "Processing...";
        status.classList.remove('text-red-500');
        status.classList.add('text-blue-500');

        try {
            let userCred;
            if(isSignup) {
                userCred = await auth.createUserWithEmailAndPassword(email, pass);
                await sendToServer(await userCred.user.getIdToken(), {
                    name: name,
                    fb_link: fbLink
                });
            } else {
                userCred = await auth.signInWithEmailAndPassword(email, pass);
                await sendToServer(await userCred.user.getIdToken());
            }
        } catch(error) {
            status.classList.remove('text-blue-500');
            status.classList.add('text-red-500');
            if (error.code === 'auth/email-already-in-use') {
                status.innerText = "Email already registered. Please Login.";
            } else if (error.code === 'auth/wrong-password') {
                status.innerText = "Incorrect Password.";
            } else {
                status.innerText = error.message;
            }
        }
    }

    async function handleGoogleAuth() {
        const status = document.getElementById('status');
        status.innerText = "Connecting to Google...";
        
        try {
            const result = await auth.signInWithPopup(googleProvider);
            // For Google, name comes from profile
            await sendToServer(await result.user.getIdToken(), {
                name: result.user.displayName,
                fb_link: "" 
            });
        } catch (error) {
            status.classList.add('text-red-500');
            console.error("Google Auth Error:", error);
            if (error.code === 'auth/unauthorized-domain') {
                status.innerText = "Error: Domain not authorized in Firebase Console.";
            } else if (error.code === 'auth/popup-closed-by-user') {
                status.innerText = "Login cancelled by user.";
            } else {
                status.innerText = error.message;
            }
        }
    }
</script>
{% endblock %}
