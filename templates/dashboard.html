{% extends "base.html" %}

{% block content %}
<style>
    /* Compact Styles */
    .glass-header {
        background: #ffffff;
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 10px;
    }
    .icon-box {
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        margin-bottom: 4px;
    }
    .stat-box {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
    }
    .tab-btn-active {
        color: #2563eb;
        border-bottom: 2px solid #2563eb;
        background: #eff6ff;
    }
</style>

<!-- 1. COMPACT PROFILE HEADER -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 mb-3 flex justify-between items-center">
    <div class="flex items-center gap-3">
        <!-- Avatar -->
        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white text-lg font-bold shadow-md">
            {{ user.name[0] if user.name else user.email[0] }}
        </div>
        <!-- Info -->
        <div class="leading-tight">
            <h2 class="text-sm font-bold text-gray-800">{{ user.name }}</h2>
            <p class="text-[10px] text-gray-500">{{ user.email }}</p>
            <span class="text-[9px] bg-green-100 text-green-700 px-1.5 rounded uppercase font-bold">{{ user.role }}</span>
        </div>
    </div>
    <!-- Balance -->
    <div class="text-right">
        <p class="text-[9px] text-gray-400 uppercase font-bold">বর্তমান ব্যালেন্স</p>
        <h1 class="text-xl font-black text-blue-600">৳ {{ user.balance }}</h1>
    </div>
</div>

<!-- 2. SYSTEM NOTICE (Slim Alert) -->
<div class="bg-amber-50 border border-amber-200 rounded-lg p-2 mb-3 flex items-start gap-2">
    <i class="fas fa-bullhorn text-amber-500 text-xs mt-0.5"></i>
    <p class="text-[10px] text-amber-800 leading-tight">
        <b>নোটিশ:</b> ফেইক রেফার করলে একাউন্ট ব্যান হবে। প্রতি রেফারে ১০ টাকা বোনাস! সমস্যা হলে সাপোর্টে জানান।
    </p>
</div>

<!-- 3. ACTION GRID (App Style Icons) -->
<div class="grid grid-cols-4 gap-2 mb-3">
    <!-- Start Work -->
    <a href="/tasks" class="flex flex-col items-center bg-white p-2 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition">
        <div class="icon-box bg-blue-100 text-blue-600">
            <i class="fas fa-briefcase text-sm"></i>
        </div>
        <span class="text-[10px] font-bold text-gray-700">কাজ করুন</span>
    </a>

    <!-- Withdraw -->
    <a href="/withdraw" class="flex flex-col items-center bg-white p-2 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition">
        <div class="icon-box bg-green-100 text-green-600">
            <i class="fas fa-wallet text-sm"></i>
        </div>
        <span class="text-[10px] font-bold text-gray-700">উত্তোলন</span>
    </a>

    <!-- Tutorial -->
    <a href="/tutorial" class="flex flex-col items-center bg-white p-2 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition">
        <div class="icon-box bg-purple-100 text-purple-600">
            <i class="fas fa-play text-sm"></i>
        </div>
        <span class="text-[10px] font-bold text-gray-700">টিউটোরিয়াল</span>
    </a>

    <!-- Support -->
    <a href="https://t.me/securehx" class="flex flex-col items-center bg-white p-2 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition">
        <div class="icon-box bg-orange-100 text-orange-600">
            <i class="fab fa-telegram-plane text-sm"></i>
        </div>
        <span class="text-[10px] font-bold text-gray-700">সাপোর্ট</span>
    </a>
</div>

<!-- 4. STATS ROW (Tiny) -->
<div class="grid grid-cols-3 gap-2 mb-3">
    <div class="stat-box">
        <p class="text-[9px] text-gray-400 font-bold uppercase">Approved</p>
        <p class="text-sm font-black text-green-600">{{ stats.approved }}</p>
    </div>
    <div class="stat-box">
        <p class="text-[9px] text-gray-400 font-bold uppercase">Pending</p>
        <p class="text-sm font-black text-yellow-500">{{ stats.pending }}</p>
    </div>
    <div class="stat-box">
        <p class="text-[9px] text-gray-400 font-bold uppercase">Rejected</p>
        <p class="text-sm font-black text-red-500">{{ stats.rejected }}</p>
    </div>
</div>

<!-- 5. REFERRAL (Compact) -->
<div class="bg-gradient-to-r from-blue-900 to-indigo-900 rounded-lg p-3 text-white shadow-md mb-3">
    <div class="flex justify-between items-center mb-2">
        <div>
            <p class="text-[10px] text-blue-200 uppercase font-bold">Refer & Earn</p>
            <h3 class="text-xs font-bold">Invite friends, Get ৳10</h3>
        </div>
        <div class="text-right">
            <p class="text-[9px] text-blue-200">Total Earned</p>
            <p class="text-sm font-bold">৳ {{ user.referral_count * 10 }}</p>
        </div>
    </div>
    
    <div class="flex gap-2 bg-black/20 p-1.5 rounded-md border border-white/10">
        <input type="text" value="{{ request.url_root }}auth?ref={{ session.user_id }}" id="refLink" readonly 
               class="w-full bg-transparent border-none text-white text-[10px] px-1 focus:ring-0 truncate">
        <button onclick="copyRef()" class="bg-white text-blue-900 px-3 py-1 rounded text-[10px] font-black hover:bg-gray-100">
            COPY
        </button>
    </div>
</div>

<!-- 6. ADVERTISEMENT -->
<div class="ad-container bg-gray-50 rounded-lg mb-3">
    <script> atOptions = { 'key' : '4bbf33f7474813a836b5f0f70829032c', 'format' : 'iframe', 'height' : 60, 'width' : 468, 'params' : {} }; </script>
    <script src="https://www.highperformanceformat.com/4bbf33f7474813a836b5f0f70829032c/invoke.js"></script>
</div>

<!-- 7. HISTORY & TEAM TABS -->
<div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden mb-20">
    <div class="flex border-b border-gray-100">
        <button onclick="showTab('history')" id="btn-history" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-wider tab-btn-active transition">
            লেনদেন হিস্টোরি
        </button>
        <button onclick="showTab('referrals')" id="btn-referrals" class="flex-1 py-3 text-[10px] font-bold uppercase tracking-wider text-gray-500 transition">
            আমার টিম ({{ referrals|length }})
        </button>
    </div>

    <!-- History Data -->
    <div id="tab-history" class="max-h-60 overflow-y-auto">
        {% for h in history %}
        <div class="p-3 border-b border-gray-50 flex justify-between items-center hover:bg-gray-50">
            <div>
                {% if h.type == 'withdraw_hold' %}
                    <p class="font-bold text-xs text-yellow-600">Pending Review</p>
                {% elif h.type == 'withdraw_paid' %}
                    <p class="font-bold text-xs text-green-600">Withdraw Paid</p>
                {% elif h.type == 'task_earning' %}
                    <p class="font-bold text-xs text-blue-600">Task Earning</p>
                {% else %}
                    <p class="font-bold text-xs text-gray-800 capitalize">{{ h.type.replace('_', ' ') }}</p>
                {% endif %}
                <p class="text-[9px] text-gray-400 mt-0.5">{{ h.timestamp.strftime('%d %b, %I:%M %p') }}</p>
            </div>
            <p class="font-bold text-xs {{ 'text-red-500' if h.amount < 0 else 'text-green-600' }}">
                {{ '+' if h.amount > 0 else '' }}{{ h.amount }}
            </p>
        </div>
        {% else %}
        <p class="text-center text-[10px] text-gray-400 py-6">কোনো লেনদেন পাওয়া যায়নি</p>
        {% endfor %}
    </div>

    <!-- Referral Data -->
    <div id="tab-referrals" class="hidden max-h-60 overflow-y-auto">
        {% for ref in referrals %}
        <div class="p-3 border-b border-gray-50 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-500">
                    {{ ref.name[0] }}
                </div>
                <div>
                    <p class="font-bold text-xs text-gray-800">{{ ref.name }}</p>
                    <p class="text-[9px] text-gray-400">{{ ref.joined.strftime('%d %b') }}</p>
                </div>
            </div>
            <span class="text-[9px] font-bold text-green-600 bg-green-50 px-1.5 py-0.5 rounded">Active</span>
        </div>
        {% else %}
        <p class="text-center text-[10px] text-gray-400 py-6">আপনার কোনো রেফারেল নেই</p>
        {% endfor %}
    </div>
</div>

<!-- Tab & Copy Script -->
<script>
    function copyRef() {
        var copyText = document.getElementById("refLink");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        document.execCommand("copy");
        
        const btn = event.target;
        btn.innerText = "COPIED";
        setTimeout(() => btn.innerText = "COPY", 2000);
    }

    function showTab(tabName) {
        const hTab = document.getElementById('tab-history');
        const rTab = document.getElementById('tab-referrals');
        const hBtn = document.getElementById('btn-history');
        const rBtn = document.getElementById('btn-referrals');

        if(tabName === 'history') {
            hTab.classList.remove('hidden');
            rTab.classList.add('hidden');
            hBtn.classList.add('tab-btn-active', 'text-blue-600');
            hBtn.classList.remove('text-gray-500');
            rBtn.classList.remove('tab-btn-active', 'text-blue-600');
            rBtn.classList.add('text-gray-500');
        } else {
            rTab.classList.remove('hidden');
            hTab.classList.add('hidden');
            rBtn.classList.add('tab-btn-active', 'text-blue-600');
            rBtn.classList.remove('text-gray-500');
            hBtn.classList.remove('tab-btn-active', 'text-blue-600');
            hBtn.classList.add('text-gray-500');
        }
    }
</script>
{% endblock %}
