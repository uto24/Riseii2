{% extends "base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-gray-800 border-l-4 border-blue-600 pl-3">Available Jobs</h2>

<div class="space-y-6 mb-24">
    {% for task in tasks %}
    <div class="bg-white rounded-xl shadow-md overflow-hidden relative border border-gray-100">
        
        <!-- Header -->
        <div class="p-5 flex justify-between items-start bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
            <div class="flex gap-4">
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-sm bg-blue-100 text-blue-600">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 text-lg leading-tight">{{ task.title }}</h3>
                    <span class="text-xs text-gray-500 uppercase tracking-wide font-semibold">{{ task.category }}</span>
                </div>
            </div>
            <div class="text-right">
                <span class="block text-xl font-bold text-green-600">৳{{ task.reward }}</span>
            </div>
        </div>

        <!-- Body -->
        <div class="p-5">
            <div class="bg-blue-50 p-4 rounded-lg mb-4 text-sm text-gray-700 border border-blue-100">
                <p class="font-bold text-blue-800 mb-1">Instructions:</p>
                <p class="whitespace-pre-line">{{ task.description }}</p>
            </div>

            <!-- Link Button (Optional) -->
            {% if task.task_link %}
                <a href="{{ task.task_link }}" target="_blank" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded mb-4 transition">
                    <i class="fas fa-external-link-alt mr-2"></i> Open Job Link
                </a>
            {% endif %}

            <!-- Submission Form -->
            <form action="/tasks" method="POST" enctype="multipart/form-data" class="pt-4 border-t border-dashed border-gray-300">
                <input type="hidden" name="task_id" value="{{ task.id }}">
                <input type="hidden" name="task_type" value="{{ task.proof_requirement }}">
                
                <label class="block text-xs font-bold text-gray-600 mb-2 uppercase">
                    Submit Proof ({{ task.proof_requirement }})
                </label>
                
                {% if task.proof_requirement == 'image' %}
                    <div class="relative">
                        <input type="file" name="image" accept="image/*" required 
                               class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                               onchange="compressImage(this)">
                        <p class="text-xs text-green-600 mt-1 hidden compression-msg font-bold">
                            <i class="fas fa-cog fa-spin"></i> Compressing image...
                        </p>
                    </div>
                {% else %}
                    <input type="text" name="proof_text" placeholder="Paste proof here" 
                           required class="w-full border border-gray-300 p-3 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                {% endif %}
                
                <button type="submit" class="w-full mt-4 bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-black transition submit-btn shadow-lg">
                    Submit for Review
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-10 bg-white rounded-xl shadow mt-10">
        <div class="bg-green-100 w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4">
            <i class="fas fa-check text-green-600 text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800">All Caught Up!</h3>
        <p class="text-gray-500 font-medium mt-2">You have completed all available tasks.</p>
        <p class="text-sm text-gray-400">Please check back later for new jobs.</p>
    </div>
    {% endfor %}
</div>
<script>
    function compressImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const parent = input.parentElement; 
            const msg = parent.querySelector('.compression-msg');
            const submitBtn = input.closest('form').querySelector('.submit-btn');

            msg.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800; // Reduced size for faster upload
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(function(blob) {
                        const compressedFile = new File([blob], "proof.jpg", {
                            type: "image/jpeg",
                            lastModified: Date.now()
                        });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        input.files = dataTransfer.files;

                        msg.innerText = "Ready to upload!";
                        msg.classList.remove('text-green-600');
                        msg.classList.add('text-blue-600');
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }, 'image/jpeg', 0.6);
                }
            }
        }
    }
</script>
<!-- JS Script আগের মতোই থাকবে (compressImage) -->
<script>
    // ... compressImage function here ...
    function compressImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const parent = input.parentElement; 
            const msg = parent.querySelector('.compression-msg');
            const submitBtn = input.closest('form').querySelector('.submit-btn');

            msg.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800; 
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(function(blob) {
                        const compressedFile = new File([blob], "proof.jpg", {
                            type: "image/jpeg",
                            lastModified: Date.now()
                        });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        input.files = dataTransfer.files;

                        msg.innerText = "Ready to upload!";
                        msg.classList.remove('text-green-600');
                        msg.classList.add('text-blue-600');
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }, 'image/jpeg', 0.6);
                }
            }
        }
    }
</script>
{% endblock %}
