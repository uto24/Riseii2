{% extends "base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Available Tasks</h2>

<div class="space-y-4 mb-20">
    {% for task in tasks %}
    <div class="bg-white p-5 rounded-lg shadow border-l-4 border-blue-500">
        <div class="flex justify-between items-start">
            <div>
                <h3 class="font-bold text-lg">{{ task.title }}</h3>
                <p class="text-sm text-gray-600">{{ task.description }}</p>
                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mt-2 capitalize">{{ task.task_type }}</span>
            </div>
            <div class="text-right">
                <span class="block text-xl font-bold text-green-600">à§³{{ task.reward }}</span>
            </div>
        </div>

        <!-- Form Start -->
        <form action="/tasks" method="POST" enctype="multipart/form-data" class="mt-4 pt-4 border-t task-form">
            <input type="hidden" name="task_id" value="{{ task.id }}">
            <input type="hidden" name="task_type" value="{{ task.proof_requirement }}">
            
            <label class="block text-xs font-bold mb-1">Submit Proof ({{ task.proof_requirement }})</label>
            
            {% if task.proof_requirement == 'image' %}
                <!-- Image Input with Compression Logic -->
                <input type="file" name="image" accept="image/*" required 
                       class="w-full text-sm mb-2 file-compressor" 
                       onchange="compressImage(this)">
                <p class="text-xs text-green-600 hidden compression-msg">Compressing image...</p>
            {% else %}
                <input type="text" name="proof_text" placeholder="Paste link or text here" required class="w-full border p-2 rounded text-sm mb-2">
            {% endif %}
            
            <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded text-sm hover:bg-gray-900 submit-btn">Submit Task</button>
        </form>
    </div>
    {% else %}
    <p class="text-center text-gray-500">No tasks available right now.</p>
    {% endfor %}
</div>

<!-- JavaScript for Image Compression -->
<script>
    function compressImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const msg = input.nextElementSibling; // The compression message
            const submitBtn = input.closest('form').querySelector('.submit-btn');

            // Show loading
            msg.classList.remove('hidden');
            msg.innerText = "Processing image (Please wait)...";
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');

            const reader = new FileReader();
            reader.readAsDataURL(file);

            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;

                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Resize logic (Max width 1024px)
                    const MAX_WIDTH = 1024;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to JPEG with 70% quality
                    canvas.toBlob(function(blob) {
                        // Create a new file from the blob
                        const compressedFile = new File([blob], "compressed.jpg", {
                            type: "image/jpeg",
                            lastModified: Date.now()
                        });

                        // Replace the file in the input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        input.files = dataTransfer.files;

                        // UI Feedback
                        msg.innerText = "Image compressed & ready!";
                        msg.classList.add('text-green-600');
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50');
                        
                    }, 'image/jpeg', 0.7); // 0.7 means 70% quality
                }
            }
        }
    }
</script>
{% endblock %}
